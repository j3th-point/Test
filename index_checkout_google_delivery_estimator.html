<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Mare's Cakes &amp; Pastries — Order Online</title>
<meta content="Order banana bread, cake loaves and more from Mare's Cakes &amp; Pastries. Secure Paystack payment; WhatsApp order link appears after payment." name="description"/>
<script defer="" src="https://cdn.tailwindcss.com"></script>
<script crossorigin="" defer="" src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin="" defer="" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script defer="" src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link href="https://res.cloudinary.com/dvl40rhin/image/upload/v1767530312/Mare_s_cakes_and_pastries_logo_tbwffm.png" rel="icon"/>
<style>
    :root{
      --brand-primary:#65383d;  /* from logo */
      --brand-accent:#dfd48c;   /* from logo */
      --brand-bg:#fbf6ec;
    }
    .fade-in { animation: fade 0.2s ease-in; }
    @keyframes fade { from{opacity:0} to{opacity:1} }
  </style>
<style>
/* --- Responsive + performance-minded tweaks (injected) --- */
:root {
  --space: clamp(0.75rem, 1.2vw, 1rem);
  --space-lg: clamp(1rem, 2vw, 1.5rem);
  --radius: 16px;
}
html { -webkit-text-size-adjust: 100%; }
body { margin: 0; padding: 0; }
.container, .wrap, .section, .sheet {
  padding: var(--space);
}
.card, .panel, .sheet {
  border-radius: var(--radius);
  overflow: hidden;
}
img { max-width: 100%; height: auto; display: block; }
.button, button, .btn {
  min-height: 44px;
  padding: 0.8rem 1rem;
  border-radius: 9999px;
  font-weight: 600;
  width: 100%;
}
input, select, textarea {
  min-height: 44px;
  padding: 0.75rem 0.9rem;
  border-radius: 12px;
}
.grid {
  display: grid;
  gap: var(--space);
}
/* Two columns collapse to one on small screens */
.grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
@media (max-width: 640px) {
  .grid-2 { grid-template-columns: 1fr; }
  .hide-sm { display: none !important; }
  .hero-title { font-size: clamp(1.25rem, 7vw, 2rem); }
  .hero-sub { font-size: clamp(0.9rem, 4vw, 1rem); }
}
/* Smoothen animations & scrolling */
* { scroll-behavior: smooth; }
@media (prefers-reduced-motion: reduce) {
  * { animation: none !important; transition: none !important; }
}
/* Improve tap highlights on mobile */
a, button { -webkit-tap-highlight-color: rgba(0,0,0,0.05); }
</style></head>
<body class="bg-[var(--brand-bg)] text-zinc-800">
<div id="root"></div>
<noscript><div style="padding:16px;background:#fff3cd;color:#7a5b00">This site requires JavaScript to run.</div></noscript>
<script data-presets="react,env" type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // ===== CONFIG =====
    const BRAND = { name: "Mare's Cakes & Pastries", short: "Mare's", color: "var(--brand-primary)" };
    const PAYMENT = { paystackPublicKey: "pk_live_e6cab8c613057e6cc0c0a5f1c09d24b34fc01b34" };
    const BUSINESS = { whatsappPhone: "2349065307788" };
    const GOOGLE = { apiKey: "", pickupAddress: "FJFX+945, Rd 3, Sunview Estate, Sangotedo 106104, Lagos, Nigeria" };
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbwuNDLgTA1vWNZResox1KW88B1YZ_ksbd-P8Oki01y0tDnxXpriIFIXA2D5YFjTk4DR/exec";
    const N = (n)=> `₦${(n??0).toLocaleString("en-NG")}`;
    const DEFAULT_SIZES = ["Medium","Regular","Mini"];
    const CHINCHIN_SIZES = ["Small Pouch", "Medium Pouch", "1.5 Litre", "2 Litre", "3 Litre", "4 Litre"];
    const getSizeOptions = (item)=> (item.group === "Chinchin" ? CHINCHIN_SIZES : DEFAULT_SIZES);
    const DEBUG = /[?&]debug=1/.test(location.search);

    // ===== MENU =====
        const ITEMS = [
      {id:"bb_classic", group:"Banana Bread", name:"Classic Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759079789/Classic_Banana_Bread_apwoe3.jpg", variants:{ Mini:1746, Medium:6002, Regular:8731 }},
      {id:"bb_raisins", group:"Banana Bread", name:"Raisins Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759079885/Raisins_Banana_Bread_y8dyxt.jpg", variants:{ Mini:2073, Medium:6548, Regular:9604 }},
      {id:"bb_choco", group:"Banana Bread", name:"Chocolate Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759079973/chocolate_banana_bread_ybedbi.jpg", variants:{ Mini:2183, Medium:6548, Regular:9822 }},
      {id:"bb_nutty", group:"Banana Bread", name:"Nutty Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080017/Nutty_Banana_Bread_xe61cb.jpg", variants:{ Mini:2784, Medium:8294, Regular:11241 }},
      {id:"bb_classic_ganache", group:"Banana Bread", name:"Classic \u00d7 Ganache Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080095/Classic_Ganache_Banana_Bread_mhgqqq.jpg", variants:{ Mini:2073, Medium:6548, Regular:9604 }},
      {id:"bb_choc_chips", group:"Banana Bread", name:"Chocolate Chips Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080154/Chocolate_Chips_Banana_Bread_begokb.jpg", variants:{ Mini:2073, Medium:6548, Regular:9168 }},
      {id:"bb_coconut", group:"Banana Bread", name:"Coconut Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080217/Coconut_Banana_Bread_vjop89.jpg", variants:{ Mini:2073, Medium:6766, Regular:9822 }},
      {id:"bb_oreo_choc", group:"Banana Bread", name:"Oreo \u00d7 Chocolate Chips Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080265/Oreo_Chocolate_Chips_Banana_Bread_u4b0fq.jpg", variants:{ Mini:2674, Medium:8185, Regular:10914 }},
      {id:"bb_oreo_delight", group:"Banana Bread", name:"Oreo Delight Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080328/Oreo_Delight_Banana_Bread_d3sa3n.jpg", variants:{ Mini:2291, Medium:7094, Regular:9822 }},
      {id:"bb_baileys", group:"Banana Bread", name:"Baileys Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080402/Baileys_Banana_Bread_eqdbsw.jpg", variants:{ Mini:2291, Medium:7203, Regular:9822 }},
      {id:"bb_baileys_coco", group:"Banana Bread", name:"Baileys \u00d7 Coconut Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080449/Baileys_Coconut_Banana_Bread_pa0xoz.jpg", variants:{ Mini:2729, Medium:8731, Regular:11460 }},
      {id:"bb_coco_choc_chips", group:"Banana Bread", name:"Coconut \u00d7 Chocolate Chips Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080449/Baileys_Coconut_Banana_Bread_pa0xoz.jpg", variants:{ Mini:2291, Medium:6766, Regular:9168 }},
      {id:"bb_baileys_delight", group:"Banana Bread", name:"Baileys Delight Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080402/Baileys_Banana_Bread_eqdbsw.jpg", variants:{ Mini:2784, Medium:8731, Regular:11460 }},
      {id:"cl_choc", group:"Cake Loaf", name:"Chocolate Cake Loaf", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080618/Chocolate_Cake_Loaf_gl8vbi.jpg", variants:{ Mini:2729, Medium:6003, Regular:8746 }},
      {id:"cl_redvelvet", group:"Cake Loaf", name:"Red Velvet Cake Loaf", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080697/Red_Velvet_Cake_Loaf_aripvz.jpg", variants:{ Mini:2947, Medium:6548, Regular:9277 }},
      {id:"cl_darkchoc", group:"Cake Loaf", name:"Dark Chocolate Cake Loaf", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080759/Dark_Chocolate_Cake_Loaf_wt5o85.jpg", variants:{ Mini:2838, Medium:6003, Regular:9277 }},
      {id:"cl_carrot", group:"Cake Loaf", name:"Carrot Cake Loaf", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080848/Carrot_Cake_Loaf_rovgf7.jpg", variants:{ Mini:null, Medium:6548, Regular:9168 }},
      {id:"cl_cookies_cream", group:"Cake Loaf", name:"Cookies & Cream Cake Loaf", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1767543105/cookies-and-cream-cake_u768po.jpg", variants:{ Mini:2729, Medium:6003, Regular:8746 }},
      {id:"cc_chinchin", group:"Chinchin", name:"Chinchin", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1767542604/chinchin_y6apof.jpg", variants:{ "Small Pouch":2183, "Medium Pouch":4365, "1.5 Litre":6091, "2 Litre":7640, "3 Litre":11460, "4 Litre":15279 }},
    ];

    // ===== UI PRIMITIVES =====
    const Section = ({ title, children, right }) => (
      <section className="bg-white border border-zinc-200 rounded-2xl shadow-sm p-5 md:p-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg md:text-xl font-semibold">{title}</h2>
          {right}
        </div>
        {children}
      </section>
    );

    const Qty = ({ value, onChange, min = 0 }) => (
      <div className="inline-flex items-center rounded-xl border border-zinc-300 overflow-hidden">
        <button className="px-3 py-1.5 hover:bg-zinc-50" onClick={() => onChange(Math.max(min, (value || 0) - 1))}>−</button>
        <input className="w-14 text-center py-1.5 outline-none" type="number" min={min} value={value || 0} onChange={(e) => onChange(Math.max(min, Number(e.target.value)))} />
        <button className="px-3 py-1.5 hover:bg-zinc-50" onClick={() => onChange((value || 0) + 1)}>＋</button>
      </div>
    );

    function useCart(){
      const [cart, setCart] = useState({});
      const setQty = (key, entry) => {
        setCart((c)=>{
          const copy = {...c};
          if (!entry || (entry.qty||0) <= 0) delete copy[key]; else copy[key] = entry;
          return copy;
        });
      };
      return { cart, setQty, setCart };
    }

    // ===== PAYSTACK LOADER (robust) =====
    let __paystackScriptLoading;
    function ensurePaystack(){
      if (typeof window !== 'undefined' && window.PaystackPop) return Promise.resolve('already');
      if (__paystackScriptLoading) return __paystackScriptLoading;
      __paystackScriptLoading = new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = 'https://js.paystack.co/v1/inline.js';
        s.async = true;
        s.onload = ()=> resolve('loaded');
        s.onerror = ()=> reject(new Error('Failed to load Paystack'));
        document.body.appendChild(s);
      });
      return __paystackScriptLoading;
    }

    
// ===== GOOGLE MAPS LOADER (optional) =====
let __gmapsLoading;
function ensureGoogleMaps(){
  if (!GOOGLE.apiKey) return Promise.reject(new Error('Missing Google Maps API key'));
  if (window.google && window.google.maps) return Promise.resolve('already');
  if (__gmapsLoading) return __gmapsLoading;
  __gmapsLoading = new Promise((resolve, reject)=>{
    const s = document.createElement('script');
    s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE.apiKey)}&libraries=places`;
    s.async = true;
    s.defer = true;
    s.onload = ()=> resolve('loaded');
    s.onerror = ()=> reject(new Error('Failed to load Google Maps'));
    document.head.appendChild(s);
  });
  return __gmapsLoading;
}

    // ===== HEADER =====
    const Header = () => (
      <header className="sticky top-0 z-40 backdrop-blur bg-white/70 border-b border-zinc-200">
        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-[var(--brand-accent)]/10 grid place-items-center overflow-hidden">
              <img src="https://res.cloudinary.com/dvl40rhin/image/upload/v1767530312/Mare_s_cakes_and_pastries_logo_tbwffm.png" alt="Mare's Cakes & Pastries logo" className="w-9 h-9 object-contain"/>
            </div>
            <div className="leading-tight">
              <div className="text-xl font-bold" style={{color:BRAND.color}}>{BRAND.name}</div>
              <div className="text-xs text-zinc-500">Each bite will make you say MARE-Y me.</div>
            </div>
          </div>
          <a href="#order" className="hidden md:inline-flex items-center gap-2 px-4 py-2 rounded-xl text-white" style={{backgroundColor:BRAND.color}}>Order Now</a>
        </div>
      </header>
    );

    // ===== PRIVACY =====
    function PrivacyContent(){
      return (
        <div>
          <h1 className="text-2xl font-bold mb-4">Privacy Policy</h1>
          <p className="mb-3">
            We collect and process your <strong>personal data</strong> (name, phone number, and email address — and delivery address only if you provide it) solely to:
          </p>
          <ul className="list-disc pl-6 space-y-1 mb-4">
            <li>Fulfil and support your order (payment confirmation, delivery coordination, customer support).</li>
            <li>Run basic, privacy-aware <strong>analytics</strong> to improve our products and service.</li>
          </ul>
          <p className="mb-3">
            We do <strong>not</strong> sell your personal data. We only share what’s necessary to process your payment and deliver your order.
          </p>
          <p className="mb-3">
            We retain order records for as long as needed for business and legal/accounting purposes.
          </p>
          <p className="text-sm text-zinc-500">
            By placing an order, you consent to the processing of your personal data as described here.
          </p>
        </div>
      );
    }

    function PrivacyModal({ open, onClose }){
      React.useEffect(()=>{
        if (!open) return;
        const onKey = (e)=>{ if (e.key === 'Escape') onClose(); };
        document.addEventListener('keydown', onKey);
        return ()=> document.removeEventListener('keydown', onKey);
      }, [open, onClose]);
      if (!open) return null;
      return (
        <div className="fixed inset-0 z-50">
          <div className="absolute inset-0 bg-black/40" onClick={onClose}/>
          <div className="absolute inset-0 flex items-center justify-center p-4">
            <div className="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 max-h-[80vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg font-semibold">Privacy Policy</h2>
                <button onClick={onClose} className="px-2 py-1 rounded hover:bg-zinc-100">✕</button>
              </div>
              <PrivacyContent/>
            </div>
          </div>
        </div>
      );
    }

    
// ===== OPTIONAL DELIVERY ESTIMATOR (GOOGLE) =====
function DeliveryEstimator(){
  const [ready, setReady] = useState(false);
  const [err, setErr] = useState('');
  const [destText, setDestText] = useState('');
  const [result, setResult] = useState(null); // {distanceText, durationText, low, high}
  const mapRef = React.useRef(null);
  const mapObj = React.useRef(null);
  const pickupMarker = React.useRef(null);
  const destMarker = React.useRef(null);
  const destLatLng = React.useRef(null);
  const autocompleteRef = React.useRef(null);

  // init map + autocomplete
  useEffect(()=>{
    let cancelled = false;
    setErr('');
    setReady(false);

    ensureGoogleMaps().then(()=>{
      if (cancelled) return;
      const g = window.google;

      // Map
      const el = mapRef.current;
      if (!el) return;
      const lagos = { lat: 6.5244, lng: 3.3792 };
      mapObj.current = new g.maps.Map(el, {
        center: lagos,
        zoom: 11,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
      });

      // Geocode pickup (fixed)
      const geocoder = new g.maps.Geocoder();
      geocoder.geocode({ address: GOOGLE.pickupAddress }, (res, status)=>{
        if (cancelled) return;
        if (status !== 'OK' || !res || !res[0]) {
          setErr('Could not load pickup location. Please refresh and try again.');
          return;
        }
        const loc = res[0].geometry.location;
        mapObj.current.setCenter(loc);
        mapObj.current.setZoom(14);
        pickupMarker.current = new g.maps.Marker({
          map: mapObj.current,
          position: loc,
          label: 'P',
          title: 'Pickup (fixed): Sunview Estate',
        });
        setReady(true);
      });

      // Click-to-pick destination
      mapObj.current.addListener('click', (e)=>{
        if (!e || !e.latLng) return;
        destLatLng.current = e.latLng;
        if (!destMarker.current) {
          destMarker.current = new g.maps.Marker({ map: mapObj.current, position: e.latLng, draggable: true, label: 'D' });
          destMarker.current.addListener('dragend', (ev)=>{
            destLatLng.current = ev.latLng;
          });
        } else {
          destMarker.current.setPosition(e.latLng);
        }
      });

      // Places autocomplete on the input (if present)
      const input = document.getElementById('delivery-dest-input');
      if (input && g.maps.places && g.maps.places.Autocomplete) {
        autocompleteRef.current = new g.maps.places.Autocomplete(input, {
          componentRestrictions: { country: 'ng' },
          fields: ['geometry', 'formatted_address', 'name'],
        });
        autocompleteRef.current.addListener('place_changed', ()=>{
          const place = autocompleteRef.current.getPlace();
          if (!place || !place.geometry || !place.geometry.location) return;
          const loc = place.geometry.location;
          destLatLng.current = loc;
          if (!destMarker.current) {
            destMarker.current = new g.maps.Marker({ map: mapObj.current, position: loc, draggable: true, label: 'D' });
            destMarker.current.addListener('dragend', (ev)=>{ destLatLng.current = ev.latLng; });
          } else {
            destMarker.current.setPosition(loc);
          }
          mapObj.current.panTo(loc);
        });
      }
    }).catch((e)=>{
      if (cancelled) return;
      setErr(
        !GOOGLE.apiKey
          ? 'Delivery estimator needs a Google Maps API key. Add it in the code: GOOGLE.apiKey.'
          : 'Could not load Google Maps. Please check your connection and try again.'
      );
    });

    return ()=>{ cancelled = true; };
  }, []);

  async function estimate(){
    setErr('');
    setResult(null);
    if (!ready) return setErr('Map is still loading. Try again in a moment.');
    const g = window.google;
    if (!g || !g.maps) return setErr('Google Maps not ready yet.');

    const origins = [GOOGLE.pickupAddress];
    const destinations = [];

    if (destLatLng.current) destinations.push(destLatLng.current);
    else if (destText.trim()) destinations.push(destText.trim());
    else return setErr('Pick your delivery point on the map or type an address.');

    const svc = new g.maps.DistanceMatrixService();
    svc.getDistanceMatrix({
      origins,
      destinations,
      travelMode: g.maps.TravelMode.DRIVING,
      unitSystem: g.maps.UnitSystem.METRIC,
    }, (res, status)=>{
      if (status !== 'OK' || !res?.rows?.[0]?.elements?.[0] || res.rows[0].elements[0].status !== 'OK') {
        setErr('Could not estimate delivery for that location. Try a nearby landmark.');
        return;
      }
      const el = res.rows[0].elements[0];
      const distanceM = el.distance.value;
      const durationS = el.duration.value;
      const km = distanceM / 1000;

      // Simple Bolt-style estimate model (tunable)
      const base = 1500;
      const perKm = 250;
      const perMin = 30;

      const mins = durationS / 60;
      const raw = base + (km * perKm) + (mins * perMin);

      // Range to mimic dynamic pricing
      const low = Math.round(raw * 0.85 / 50) * 50;
      const high = Math.round(raw * 1.20 / 50) * 50;

      setResult({
        distanceText: el.distance.text,
        durationText: el.duration.text,
        low, high
      });
    });
  }

  return (
    <Section
      title="Estimate Delivery (optional)"
      right={<span className="text-xs text-zinc-500">Pickup: Sunview Estate</span>}
    >
      <div className="space-y-3">
        <p className="text-sm text-zinc-600">
          This is an estimate (Bolt prices may change with traffic and demand). Tap the map to choose your delivery point.
        </p>

        {!GOOGLE.apiKey && (
          <div className="rounded-xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-800">
            <div className="font-semibold mb-1">Google Maps key needed</div>
            Add your key in the code: <code className="px-1 bg-white rounded">GOOGLE.apiKey</code>.
          </div>
        )}

        <div className="grid md:grid-cols-2 gap-3 items-start">
          <div className="space-y-2">
            <label className="text-sm text-zinc-600">Delivery address / landmark (optional)</label>
            <input
              id="delivery-dest-input"
              className="w-full rounded-xl border border-zinc-300 px-3 py-2"
              placeholder="Type address (or tap map)"
              value={destText}
              onChange={(e)=>setDestText(e.target.value)}
            />
            <button
              type="button"
              onClick={estimate}
              className="w-full py-3 rounded-2xl text-white font-semibold disabled:opacity-50"
              style={{backgroundColor:'var(--brand-primary)'}}
              disabled={!GOOGLE.apiKey}
            >
              Estimate delivery
            </button>

            {err && <div className="text-sm text-red-600">{err}</div>}

            {result && (
              <div className="rounded-xl border border-zinc-200 bg-zinc-50 p-3 text-sm">
                <div className="flex justify-between"><span>Distance</span><span className="font-semibold">{result.distanceText}</span></div>
                <div className="flex justify-between"><span>ETA</span><span className="font-semibold">{result.durationText}</span></div>
                <hr className="my-2"/>
                <div className="flex justify-between text-base">
                  <span>Estimated delivery</span>
                  <span className="font-semibold">{N(result.low)} – {N(result.high)}</span>
                </div>
              </div>
            )}
          </div>

          <div>
            <div className="rounded-2xl overflow-hidden border border-zinc-200 bg-white">
              <div ref={mapRef} style={{ height: 320, width: '100%' }} />
            </div>
            <div className="text-xs text-zinc-500 mt-2">P = pickup (fixed), D = delivery</div>
          </div>
        </div>
      </div>
    </Section>
  );
}

    // ===== APP =====
    function App(){
      // Auto-close sheet when app/tab is backgrounded (typical after opening WA)
      useEffect(() => {
        const vis = () => {
          if (document.visibilityState === 'hidden') {
            // If the user switched away (likely to WhatsApp), close the sheet
            setPostPay(s => s.visible ? {...s, visible:false} : s);
          }
        };
        document.addEventListener('visibilitychange', vis);
        return () => document.removeEventListener('visibilitychange', vis);
      }, []);

      const { cart, setQty, setCart } = useCart();
      const [postPay, setPostPay] = useState({ visible:false, link:'', ref:'', items:[], subtotal:0, total:0 });
      const [form, setForm] = useState({ name:"", phone:"", email:"", delivery:"", consent:false });
      const [selectedSize, setSelectedSize] = useState({});
      const [showPrivacy, setShowPrivacy] = useState(false);
      const [showCheckout, setShowCheckout] = useState(false);
      const [isPaying, setIsPaying] = useState(false);
      const [errors, setErrors] = useState({});

      const lineTotal = (e)=> (e.price||0)*(e.qty||0);
      const subtotal = useMemo(()=> Object.values(cart).reduce((s, e)=> s + lineTotal(e), 0), [cart]);
      const grandTotal = useMemo(()=> subtotal, [subtotal]);

      // Mini-only rule: if ONLY minis are in cart, need >= 4 combined
      const totalMiniQty = useMemo(() => Object.entries(cart)
        .reduce((sum, [key, it]) => key.endsWith('__Mini') ? sum + (it.qty||0) : sum, 0), [cart]);
      const hasNonMini = useMemo(() => Object.keys(cart).some(k => !k.endsWith('__Mini')), [cart]);
      const miniSelectedAndInsufficient = totalMiniQty > 0 && totalMiniQty < 4;

      // Clear cart-related errors as user updates cart
      useEffect(()=>{
        if (!errors.cart && !errors.mini) return;
        const hasCart = grandTotal > 0;
        const miniOk = !(totalMiniQty > 0 && totalMiniQty < 4);
        if (hasCart && miniOk) setErrors(s=>({ ...s, cart: undefined, mini: undefined }));
      }, [grandTotal, totalMiniQty]);

      const getDefaultSize = (item)=> getSizeOptions(item).find(sz => item.variants[sz]);
      const getActiveSize = (item)=> selectedSize[item.id] || getDefaultSize(item);
      const getPrice = (item, sz)=> item.variants[sz] || 0;
      const cartKey = (item, sz)=> `${item.id}__${sz}`;
      const cartName = (item, sz)=> `${item.name} (${sz})`;

      // WhatsApp text
      const makeWhatsAppText = (paymentRef) => {
        const lines = [
          `*New Order — ${BRAND.name}*`,
          `Name: ${form.name}`,
          `Phone: ${form.phone}`,
          `Email: ${form.email}`,          form.delivery ? `Delivery Location: ${form.delivery}` : null,
          '', '*Items*',
          ...Object.entries(cart).map(([key, it])=>`- ${it.name} x${it.qty} = ${N(lineTotal(it))}`),
          '', `*Subtotal:* ${N(subtotal)}`,
          `*Total:* ${N(grandTotal)}`,
          paymentRef ? `Payment Ref: ${paymentRef}` : null
        ].filter(Boolean);
        return encodeURIComponent(lines.join("\n"));
      };

      // Prefer a WhatsApp URL that works on Safari/iOS too
      function buildWhatsAppLink(paymentRef){
        const text = makeWhatsAppText(paymentRef);
        const phone = BUSINESS.whatsappPhone;
        // api.whatsapp.com is the most reliable across Safari, iOS and desktop
        return `https://api.whatsapp.com/send?phone=${phone}&text=${text}`;
      }

      // Send to Google Sheet webhook
      async function sendOrderToWebhook(payload){
        try{
          if(!WEBHOOK_URL) return;
          if (navigator.sendBeacon) {
            const blob = new Blob([JSON.stringify(payload)], { type: 'text/plain;charset=utf-8' });
            navigator.sendBeacon(WEBHOOK_URL, blob);
          } else {
            await fetch(WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload), mode:'no-cors', keepalive:true });
          }
        }catch(err){ console.warn('Webhook failed:', err); }
      }

      async function handlePaystack(){
        if (isPaying) return;

        const errs = {};
        if (!form.consent) errs.consent = 'Please consent to the Privacy Policy to continue.';
        if (!form.name) errs.name = 'Full Name is required.';
        if (!form.phone) errs.phone = 'Phone number is required.';
        if (!form.email) errs.email = 'Email address is required.';
        if (grandTotal <= 0) errs.cart = 'Your cart is empty.';
        if (miniSelectedAndInsufficient) errs.mini = 'Minimum order for Mini sizes is 4 (any flavours).';

        if (Object.keys(errs).length) {
          setErrors(errs);
          // Bring the user back to the form/summary
          try { document.getElementById('order')?.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(_) {}
          return;
        } else {
          // Clear any previous errors
          setErrors({});
        }
        try{
          setIsPaying(true);
          setShowCheckout(false);
          const state = await ensurePaystack().then(r=>({ ok:true, r })).catch(e=>({ ok:false, e }));
          if (!state.ok || !window.PaystackPop || typeof window.PaystackPop.setup !== 'function') {
            setIsPaying(false);
            console.error('Paystack not available', state);
            return alert('Paystack couldn\'t load. Check your connection and try again.');
          }
          const amountKobo = Math.round(grandTotal * 100);
          const payEmail = form.email;
          let handler;
          try {
            handler = window.PaystackPop.setup({
              key: PAYMENT.paystackPublicKey,
              email: payEmail,
              amount: amountKobo,
              currency: 'NGN',
              metadata: { custom_fields: [
                { display_name: 'Customer', variable_name: 'customer_name', value: form.name },
                { display_name: 'Phone', variable_name: 'phone', value: form.phone },                { display_name: 'Delivery', variable_name: 'delivery_location', value: (form.delivery || '') }
              ]},
              callback: (response) => {
                try {
                  const paymentRef = response && response.reference ? response.reference : '';
                  const items = Object.entries(cart).map(([key, it])=>({ name: it.name, qty: it.qty, unit_price: it.price, line_total: (it.price||0)*(it.qty||0) }));
                  const payload = {
                    provider: 'paystack',
                    payment_ref: paymentRef,
                    currency: 'NGN',
                    totals: { subtotal: subtotal, total: grandTotal },
                    customer: { name: form.name, phone: form.phone, email: (form.email || ""), delivery: (form.delivery || ""), consent: true },
                    items,
                    business: { name: BRAND.name },
                    created_at: new Date().toISOString()
                  };
                  sendOrderToWebhook(payload);

                  const link = buildWhatsAppLink(paymentRef);
                  // Always show the fallback WhatsApp button for ALL browsers/devices
                  setPostPay({ visible:true, link, ref: paymentRef, items, subtotal, total: grandTotal });
                } catch(err) {
                  console.error('Callback error:', err);
                  alert('Payment succeeded but we had trouble preparing your WhatsApp order link. Please contact us.');
                } finally {
                  setIsPaying(false);
                }
              },
              onClose: function(){
                setIsPaying(false);
              }
            });
          } catch(setupErr){
            setIsPaying(false);
            console.error('Paystack setup error', setupErr);
            return alert('Could not start Paystack. Please refresh and try again.');
          }
          try { handler.openIframe(); } catch(openErr){ setIsPaying(false); console.error('openIframe failed', openErr); alert('Could not open Paystack window. Try again.'); }
        }catch(e){ setIsPaying(false); console.error('handlePaystack failed', e); alert('Unexpected error. Please try again.'); }
      }

      const SizePills = ({ item, totalMiniQty, hasNonMini }) => {
        const active = getActiveSize(item);
        const showBadge = item.variants.Mini;
        const badgeOk = totalMiniQty >= 4;
        return (
          <div className="flex items-center gap-2">
            <div className="flex gap-1.5">
              {getSizeOptions(item).map(sz=>{
                const available = !!item.variants[sz];
                const isActive = active === sz;
                return (
                  <button key={sz}
                    className={`px-2.5 py-1 rounded-lg text-xs border ${isActive? 'border-zinc-900 font-semibold' : 'border-zinc-300'} ${available? '' : 'opacity-40 cursor-not-allowed'}`}
                    onClick={()=> available && setSelectedSize(s=>({...s, [item.id]: sz}))}
                    disabled={!available}
                  >{sz}</button>
                );
              })}
            </div>
            {showBadge && (
              <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] leading-none border ${badgeOk ? 'bg-emerald-50 text-emerald-700 border-emerald-200' : 'bg-red-50 text-red-700 border-red-200'}`}>
                Minis: {Math.min(totalMiniQty,4)}/4
              </span>
            )}
          </div>
        );
      };

      const QtyForItem = ({ item }) => {
        const sz = getActiveSize(item);
        const key = cartKey(item, sz);
        const price = getPrice(item, sz);
        const qty = cart[key]?.qty || 0;
        return (
          <div className="flex items-center gap-3">
            <div className="w-24 text-right font-semibold">{N(price)}</div>
            <Qty value={qty} onChange={(q)=>{
              const entry = q > 0 ? { name: cartName(item, sz), price, qty:q } : null;
              setQty(key, entry);
            }}/>
          </div>
        );
      };

      // Sticky mobile pay bar so the button is always visible
      const mobileDisabled = !form.consent || !form.name || !form.phone || !form.email || grandTotal<=0 || isPaying || miniSelectedAndInsufficient;

      return (
        <div className="min-h-screen">
          <Header/>
          <main id="order" className="max-w-6xl mx-auto px-4 pb-28 md:pb-20 grid lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-6">
              <Section title="Preorder & Delivery (Banana Bread)">
                <div className="grid md:grid-cols-2 gap-4 text-sm">
                  <div className="bg-zinc-50 border border-zinc-200 rounded-xl p-4">
                    <div className="font-semibold mb-1">Preorder Days</div>
                    <div>Mon, Wed & Thurs</div>
                    <div className="text-zinc-600">9AM – 3PM</div>
                  </div>
                  <div className="bg-zinc-50 border border-zinc-200 rounded-xl p-4">
                    <div className="font-semibold mb-1">Delivery Days</div>
                    <div>Tuesday & Friday</div>
                    <div className="text-zinc-600">9AM – 6PM</div>
                  </div>
                </div>
              </Section>

              <Section title="Menu" right={<span className="text-xs text-zinc-500">Choose size then set qty</span>}>
                <div className="divide-y">
                  {ITEMS.map((it)=> (
                    <div key={it.id} className="py-4 flex items-center gap-4">
                      <div className="w-20 h-20 flex-shrink-0 rounded-xl border border-zinc-200 overflow-hidden bg-zinc-100">
                        {it.img ? <img src={it.img} alt={it.name} className="w-full h-full object-cover"/> : <div className="w-full h-full grid place-items-center text-xs text-zinc-400">No Image</div>}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="font-medium">{it.name}</div>
                        <div className="text-xs text-zinc-500 mb-1">{it.group}</div>
                        <SizePills item={it} totalMiniQty={totalMiniQty} hasNonMini={hasNonMini} />
                      </div>
                      <QtyForItem item={it} />
                    </div>
                  ))}
                </div>
              </Section>

              <Section title="Customer">
                <div className="grid md:grid-cols-3 gap-4">
                  <div>
                    <label className="text-sm text-zinc-600">Full Name</label>
                    <input className="w-full rounded-xl border border-zinc-300 px-3 py-2" value={form.name} onChange={e=>{ setForm({...form, name:e.target.value}); setErrors(s=>({ ...s, name: undefined })); }}/>
                    {errors.name && <p className="mt-1 text-xs text-red-600">{errors.name}</p>}
                  </div>
                  <div>
                    <label className="text-sm text-zinc-600">Phone</label>
                    <input className="w-full rounded-xl border border-zinc-300 px-3 py-2" value={form.phone} onChange={e=>{ setForm({...form, phone:e.target.value}); setErrors(s=>({ ...s, phone: undefined })); }}/>
                    {errors.phone && <p className="mt-1 text-xs text-red-600">{errors.phone}</p>}
                  </div>
                  <div>
                    <label className="text-sm text-zinc-600">Email</label>
                    <input type="email" className="w-full rounded-xl border border-zinc-300 px-3 py-2" value={form.email} onChange={e=>{ setForm({...form, email:e.target.value}); setErrors(s=>({ ...s, email: undefined })); }}/>
                    {errors.email && <p className="mt-1 text-xs text-red-600">{errors.email}</p>}
                  </div>
<div className="md:col-span-2">
                    <label className="text-sm text-zinc-600">Delivery Location / Address</label>
                    <input className="w-full rounded-xl border border-zinc-300 px-3 py-2" placeholder="e.g., Yaba, Lagos — 24 Ajose Street (optional)" value={form.delivery} onChange={e=>setForm({...form, delivery:e.target.value})}/>
                  </div>
                  <div className="md:col-span-3">
                    <label className="inline-flex items-start gap-2 text-sm">
                      <input type="checkbox" className="mt-1" checked={form.consent} onChange={e=>{ setForm({...form, consent:e.target.checked}); setErrors(s=>({ ...s, consent: undefined })); }}/>
                      <span>I consent to the <button type="button" className="text-blue-600 underline" onClick={()=>setShowPrivacy(true)}>Privacy Policy</button> and agree my personal data will be used for <strong>order fulfilment</strong> and <strong>analytics only</strong>.</span>
                      {errors.consent && <p className="mt-1 text-xs text-red-600">{errors.consent}</p>}
                    </label>
                  </div>
                </div>
              </Section>
            

              <DeliveryEstimator/>
            </div>

            <div className="lg:col-span-1 space-y-6">
              <Section title="Summary" right={<span className="text-xs text-zinc-500">Summary</span>}>
                <div className="space-y-2 text-sm">
                  <div className="flex items-center justify-between"><span>Subtotal</span><span>{N(subtotal||0)}</span></div>
                  <hr className="my-1"/>
                  <div className="flex items-center justify-between font-semibold text-lg"><span>Total</span><span>{N(grandTotal||0)}</span></div>
                  <div className="space-y-2 pt-2">
                    <button onClick={()=>setShowCheckout(true)} className="w-full py-3 rounded-2xl text-white font-semibold disabled:opacity-50" style={{backgroundColor:'var(--brand-primary)'}} disabled={mobileDisabled}>
                      {'Checkout'}
                    </button>
                    <p className="text-xs text-zinc-500">After payment, a WhatsApp link will open with your order summary.</p>
                    {(errors.cart || errors.mini) && (
                      <div className="mt-2 space-y-1">
                        {errors.cart && <p className="text-xs text-red-600">{errors.cart}</p>}
                        {errors.mini && <p className="text-xs text-red-600">{errors.mini}</p>}
                      </div>
                    )}
                    <p className="text-xs text-red-600">If you add any <strong>Mini</strong> item, the minimum total is <strong>4 Minis</strong>.</p>
                    {totalMiniQty>0 && totalMiniQty<4 && (
                      <p className="text-xs text-red-600">You currently have {totalMiniQty} Mini item(s). Add {4-totalMiniQty} more Mini to proceed.</p>
                    )}
                  </div>
                </div>
              </Section>
            </div>
          </main>

          {/* Sticky mobile bar */}
          <div className="fixed md:hidden bottom-0 inset-x-0 z-50 bg-white/95 backdrop-blur border-t border-zinc-200 p-3 flex items-center gap-3">
            <div className="flex-1">
              <div className="text-xs text-zinc-500">Total</div>
              <div className="font-semibold">{N(grandTotal||0)}</div>
            </div>
            <button onClick={()=>setShowCheckout(true)} className="px-4 py-2 rounded-xl text-white font-semibold disabled:opacity-50" style={{backgroundColor:'var(--brand-primary)'}} disabled={mobileDisabled}>
              {'Checkout'}
            </button>
          </div>

          <PrivacyModal open={showPrivacy} onClose={()=>setShowPrivacy(false)} />

          {showCheckout && (
            <div className="fixed inset-0 z-50">
              <div className="absolute inset-0 bg-black/40" onClick={()=>setShowCheckout(false)}></div>
              <div className="absolute inset-x-0 bottom-0">
                <div className="bg-white rounded-t-2xl shadow-2xl p-5 max-h-[85vh] overflow-y-auto">
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="text-lg font-semibold">Checkout</h3>
                    <button className="px-2 py-1 rounded hover:bg-zinc-100" onClick={()=>setShowCheckout(false)}>✕</button>
                  </div>

                  <p className="text-sm text-zinc-600 mb-4">
                    Review your items and complete payment. After payment, a WhatsApp link will appear to send your order.
                  </p>

                  <div className="bg-zinc-50 border border-zinc-200 rounded-xl p-3 mb-4">
                    <div className="text-sm font-medium mb-2">Items</div>
                    {Object.keys(cart).length === 0 ? (
                      <div className="text-sm text-zinc-500">Your cart is empty.</div>
                    ) : (
                      <ul className="text-sm space-y-1">
                        {Object.entries(cart).map(([key, it])=> (
                          <li key={key} className="flex justify-between">
                            <span className="pr-3">{it.name} ×{it.qty}</span>
                            <span>{N(lineTotal(it))}</span>
                          </li>
                        ))}
                      </ul>
                    )}
                    <hr className="my-2"/>
                    <div className="text-sm space-y-1">
                      <div className="flex justify-between font-semibold"><span>Total</span><span>{N(grandTotal||0)}</span></div>
                      {Object.keys(cart).length > 0 && (miniSelectedAndInsufficient) && (
                        <div className="text-xs text-red-600 pt-1">
                          You selected Mini size(s). Minimum total Minis is 4. You currently have {totalMiniQty}.
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="space-y-3">
                    <button onClick={handlePaystack}
                      className="w-full py-3 rounded-2xl text-white font-semibold disabled:opacity-50"
                      style={{backgroundColor:'var(--brand-primary)'}}
                      disabled={mobileDisabled}
                    >
                      {isPaying ? 'Opening Paystack…' : 'Pay with Paystack'}
                    </button>
                    <button
                      onClick={()=>setShowCheckout(false)}
                      className="w-full py-3 rounded-2xl border border-zinc-300 font-semibold"
                    >
                      Continue Shopping
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {postPay.visible && (
            <div className="fixed inset-0 z-50">
              <div className="absolute inset-0 bg-black/40" onClick={()=>setPostPay(s=>({...s, visible:false}))}></div>
              <div className="absolute inset-x-0 bottom-0">
                <div className="bg-white rounded-t-2xl shadow-2xl p-5 max-h-[75vh] overflow-y-auto">
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="text-lg font-semibold">Order Ready to Send</h3>
                    <button className="px-2 py-1 rounded hover:bg-zinc-100" onClick={()=>setPostPay(s=>({...s, visible:false}))}>✕</button>
                  </div>
                  <p className="text-sm text-zinc-600 mb-3">Tap the button below to send your order to WhatsApp. If a tab already opened, this is a backup.</p>
                  <div className="bg-zinc-50 border border-zinc-200 rounded-xl p-3 mb-3">
                    <div className="text-sm font-medium mb-2">Items</div>
                    <ul className="text-sm space-y-1">
                      {postPay.items.map((it,idx)=> (
                        <li key={idx} className="flex justify-between">
                          <span>{it.name} ×{it.qty}</span>
                          <span>₦{((it.line_total)||0).toLocaleString('en-NG')}</span>
                        </li>
                      ))}
                    </ul>
                    <hr className="my-2"/>
                    <div className="text-sm space-y-1">
                      <div className="flex justify-between"><span>Subtotal</span><span>₦{(postPay.subtotal||0).toLocaleString('en-NG')}</span></div>
                      <div className="flex justify-between font-semibold"><span>Total</span><span>₦{(postPay.total||0).toLocaleString('en-NG')}</span></div>
                    </div>
                    {postPay.ref && (
                      <div className="text-[11px] text-zinc-500 mt-2">Payment Ref: {postPay.ref}</div>
                    )}
                  </div>
                  <a href={postPay.link}  rel="noopener" className="block w-full text-center py-3 rounded-2xl text-white font-semibold" style={{backgroundColor:'var(--brand-primary)'}}
                  onClick={() => {
                    // Give the new tab a moment to spawn, then close the sheet
                    setTimeout(() => setPostPay(s=>({...s, visible:false})), 600);
                  }}>
                    Open WhatsApp & Send Order
                  </a>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ===== MOUNT SAFELY =====
    function mountApp(){
      if (!window.React || !window.ReactDOM) return setTimeout(mountApp, 30);
      const el = document.getElementById('root');
      if (!el) return setTimeout(mountApp, 30);
      ReactDOM.createRoot(el).render(<App/>);
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', mountApp); else mountApp();

    // ===== ERROR & LOAD DIAGNOSTICS =====
    (function diagnostics(){
      const log = (...a)=>{ if (DEBUG) console.log('[diag]', ...a); };
      log('React?', !!window.React, 'ReactDOM?', !!window.ReactDOM);
      window.addEventListener('error', function(e){ console.warn('[window.onerror]', e.message, e.filename, e.lineno); });
      window.addEventListener('unhandledrejection', function(e){ console.warn('[unhandledrejection]', e.reason); });
    })();

    // ===== LIGHT TESTS =====
    (function runTests(){
      function assert(name, cond){ if(!cond){ console.error('TEST FAIL:', name); } else { console.log('TEST PASS:', name); } }
      // N formatting
      (function(){ assert('N(12345) formats', N(12345)==='₦12,345'); })();
      // Mini-only rule
      (function(){
        const cart={ 'a__Mini':{qty:3,price:1000,name:'A (Mini)' } }; const totalMini = Object.entries(cart).reduce((s,[k,v])=>k.endsWith('__Mini')?s+v.qty:s,0); const hasNonMini=false; assert('Mini-only insufficient (<4)', totalMini>0 && !hasNonMini && totalMini<4 );
        const cart2={ 'a__Mini':{qty:4,price:1000,name:'A (Mini)' } }; const tm2=Object.entries(cart2).reduce((s,[k,v])=>k.endsWith('__Mini')?s+v.qty:s,0); assert('Mini-only OK (=4)', tm2>=4);
        const cart3={ 'a__Mini':{qty:1,price:1000,name:'A (Mini)' }, 'b__Regular':{qty:1,price:2000,name:'B (Regular)'} }; const tm3=Object.entries(cart3).reduce((s,[k,v])=>k.endsWith('__Mini')?s+v.qty:s,0); const hn3=Object.keys(cart3).some(k=>!k.endsWith('__Mini')); assert('Has non-mini bypass', hn3 && tm3===1);
      })();
      // WhatsApp link correctness & encoding
      (function(){
        const txt = encodeURIComponent('hello world!\nline2');
        const phone='2349065307788';
        const url = `https://api.whatsapp.com/send?phone=${phone}&text=${txt}`;
        const ok = /api\.whatsapp\.com\/send\?phone=/.test(url) && /text=/.test(url);
        assert('WA URL uses api.whatsapp.com + has text', ok);
      })();
      // ensurePaystack returns a Promise
      (function(){
        const p = ensurePaystack();
        const isPromise = !!p && typeof p.then==='function';
        assert('ensurePaystack returns Promise', isPromise);
      })();
      // Visibility listener attachable
      (function(){
        const handlerExists = typeof document.addEventListener === 'function';
        assert('Visibility listener attachable', handlerExists);
      })();
    })();
  </script>
<script>
(function(){
  // Force WhatsApp links to open in SAME tab
  document.addEventListener('click', function(e){
    var a = e.target.closest && e.target.closest('a[href]');
    if(!a) return;
    var href = a.getAttribute('href') || '';
    if(href.indexOf('wa.me') !== -1 || href.indexOf('api.whatsapp.com') !== -1){
      e.preventDefault();
      // Close any payment sheet if your app exposes a toggle
      try {
        if (window.setPostPay) setPostPay(function(s){ return Object.assign({}, s, { visible:false }); });
      } catch(_) {}
      window.location.href = href; // same tab
    }
  }, {passive:false});
  // Mark JS-enabled for progressive enhancement
  document.documentElement.classList.add('js');
})();
</script>
<script>
// --- Enforce Paystack same-tab behavior ---
(function(){
  if (window.PaystackPop && !window.__paystackShimApplied) {
    window.__paystackShimApplied = true;
    try {
      var _setup = window.PaystackPop.setup;
      window.PaystackPop.setup = function(opts){
        var instance = _setup.call(this, opts||{});
        // Some integrations call instance.open() or openPopup(); normalize to openIframe()
        var openFn = instance.openIframe || instance.open;
        instance.open = function(){ return (instance.openIframe ? instance.openIframe() : openFn && openFn()); };
        return instance;
      };
    } catch(e){ /* noop */ }
  }
})();
</script>

</body>
</html>